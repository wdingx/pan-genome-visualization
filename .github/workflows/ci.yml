name: CI

on:
  pull_request:
  push:
    branches:
      - static-app
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref || github.run_id }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash -euxo pipefail {0}

jobs:
  build_and_deploy:
    name: 'Build and Deploy'
    runs-on: ubuntu-20.04

    steps:
      - name: Setup environment (release)
        if: endsWith(github.ref, '/release')
        run: |
          echo "ENVIRONMENT=release" >> $GITHUB_ENV
          echo "DATA_ROOT_URL=${{ secrets.RELEASE_DATA_ROOT_URL }}" >> $GITHUB_ENV
          echo "AWS_ACCESS_KEY_ID=${{ secrets.RELEASE_AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.RELEASE_AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=${{ secrets.RELEASE_AWS_DEFAULT_REGION }}" >> $GITHUB_ENV
          echo "AWS_S3_BUCKET=${{ secrets.RELEASE_AWS_S3_BUCKET }}" >> $GITHUB_ENV
          echo "AWS_CLOUDFRONT_DISTRIBUTION_ID=${{ secrets.RELEASE_AWS_CLOUDFRONT_DISTRIBUTION_ID }}" >> $GITHUB_ENV

      - name: Setup environment (master)
        if: endsWith(github.ref, '/static-app')
        run: |
          echo "ENVIRONMENT=master" >> $GITHUB_ENV
          echo "DATA_ROOT_URL=${{ secrets.MASTER_DATA_ROOT_URL }}" >> $GITHUB_ENV
          echo "AWS_ACCESS_KEY_ID=${{ secrets.MASTER_AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.MASTER_AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=${{ secrets.MASTER_AWS_DEFAULT_REGION }}" >> $GITHUB_ENV
          echo "AWS_S3_BUCKET=${{ secrets.MASTER_AWS_S3_BUCKET }}" >> $GITHUB_ENV
          echo "AWS_CLOUDFRONT_DISTRIBUTION_ID=${{ secrets.MASTER_AWS_CLOUDFRONT_DISTRIBUTION_ID }}" >> $GITHUB_ENV

      - name: Checkout source code
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 10

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq --yes
          sudo apt-get install -qq --yes --verbose-versions pigz rename

      - name: Install NPM dependencies
        run: |
          npm ci

      - name: Install AWS CLI
        run: |
          curl -fsS "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -oqq awscliv2.zip
          sudo ./aws/install --update

          mkdir -p ~/.aws/
          cp config/aws/config ~/.aws/

      - name: Build
        run: |
          : ${DATA_ROOT_URL?"Environment variable is required"}
          npm run build

      - name: Check requirements
        if: endsWith(github.ref, '/static-app') || endsWith(github.ref, '/release')
        run: |
          : ${AWS_ACCESS_KEY_ID?"Environment variable is required"}
          : ${AWS_SECRET_ACCESS_KEY?"Environment variable is required"}
          : ${AWS_DEFAULT_REGION?"Environment variable is required"}
          : ${AWS_S3_BUCKET?"Environment variable is required"}
          : ${AWS_CLOUDFRONT_DISTRIBUTION_ID?"Environment variable is required"}

      - name: Precompress files
        if: endsWith(github.ref, '/static-app') || endsWith(github.ref, '/release')
        run: |
          pigz -dfrq public/ || true
          pigz -kfrq public/

      - name: Upload non-compressed non-HTML files
        if: endsWith(github.ref, '/static-app') || endsWith(github.ref, '/release')
        run: |
          aws s3 sync \
            --delete \
            --only-show-errors \
            --cache-control "max-age=2592000, public" \
            --metadata-directive REPLACE \
            --exclude "*.git*" \
            --exclude "*.html" \
            --exclude "*.gz" \
            "public/" "s3://${AWS_S3_BUCKET}/"

      - name: Upload compressed non-HTML files
        if: endsWith(github.ref, '/static-app') || endsWith(github.ref, '/release')
        run: |
          aws s3 sync \
            --delete \
            --only-show-errors \
            --cache-control "max-age=2592000, public" \
            --content-encoding=gzip \
            --metadata-directive REPLACE \
            --exclude "*" \
            --include "*.gz" \
            --exclude "*.git*" \
            --exclude "*.html.gz" \
            "public/" "s3://${AWS_S3_BUCKET}/"

      - name: Remove non-HTML files
        if: endsWith(github.ref, '/static-app') || endsWith(github.ref, '/release')
        run: |
          find public/ -type f \( ! -iname "*.html" -a ! -iname "*.html.gz" \) -exec rm {} \+
          rename --filename 's/\.html//' public/*.html || true
          rename --filename 's/\.html//' public/*.html.gz || true

      - name: Upload non-compressed HTML files
        if: endsWith(github.ref, '/static-app') || endsWith(github.ref, '/release')
        run: |
          aws s3 sync \
            --delete \
            --only-show-errors \
            --content-type "text/html" \
            --cache-control "max-age=86400, public" \
            --metadata-directive REPLACE \
            --exclude "*.*" \
            "public/" "s3://${AWS_S3_BUCKET}/"

      - name: Upload compressed HTML files
        if: endsWith(github.ref, '/static-app') || endsWith(github.ref, '/release')
        run: |
          aws s3 sync \
            --delete \
            --only-show-errors \
            --content-type "text/html" \
            --cache-control "max-age=86400, public" \
            --content-encoding=gzip \
            --metadata-directive REPLACE \
            --exclude "*" \
            --include "*.gz" \
            --exclude "*.*.gz" \
            "public/" "s3://${AWS_S3_BUCKET}/"

      - name: Invalidate AWS Cloudfront cache
        if: endsWith(github.ref, '/static-app') || endsWith(github.ref, '/release')
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${AWS_CLOUDFRONT_DISTRIBUTION_ID} \
            --paths "/*"
